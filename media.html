<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการสื่อ (Media) - CMS Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="admin_style.css">
</head>

<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="admin-sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="assets/web_admin_logo.png" alt="Admin Logo"
                    style="width: 30px; height: auto; margin-right: 10px;">
                Web Admin
            </div>
            <ul class="sidebar-menu">
                <li><a href="admin_dashboard.html"><i class="fa-solid fa-gauge"></i> แดชบอร์ด</a></li>
                <li
                    style="padding: 10px 20px; font-size: 0.75rem; text-transform: uppercase; color: #5d6b82; font-weight: 600;">
                    เนื้อหา</li>
                <li><a href="news_content.html"><i class="fa-solid fa-newspaper"></i> บทความ (Articles)</a></li>
                <li><a href="news_categories.html"><i class="fa-solid fa-layer-group"></i> หมวดหมู่ (Categories)</a>
                </li>
                <li><a href="media.html" class="active"><i class="fa-solid fa-images"></i> สื่อ (Media)</a></li>
                <li
                    style="padding: 10px 20px; font-size: 0.75rem; text-transform: uppercase; color: #5d6b82; font-weight: 600; margin-top: 10px;">
                    โครงสร้างเว็บ</li>
                <li><a href="menus.html"><i class="fa-solid fa-bars"></i> เมนู (Menus)</a></li>
                <li><a href="header_settings.html"><i class="fa-solid fa-heading"></i> ส่วนหัว (Header)</a></li>
                <li><a href="footer_settings.html"><i class="fa-solid fa-shoe-prints"></i> ส่วนท้าย (Footer)</a></li>
                <li
                    style="padding: 10px 20px; font-size: 0.75rem; text-transform: uppercase; color: #5d6b82; font-weight: 600; margin-top: 10px;">
                    ผู้ใช้งาน</li>
                <li><a href="users.html"><i class="fa-solid fa-users"></i> จัดการผู้ใช้</a></li>
                <li
                    style="padding: 10px 20px; font-size: 0.75rem; text-transform: uppercase; color: #5d6b82; font-weight: 600; margin-top: 10px;">
                    ระบบ</li>
                <li><a href="settings.html"><i class="fa-solid fa-gears"></i> ตั้งค่าทั่วไป</a></li>
                <li><a href="theme_color.html"><i class="fa-solid fa-palette"></i> ธีมสี (Theme Color)</a></li>
                <li><a href="fonts.html"><i class="fa-solid fa-font"></i> ฟ้อนต์ (Fonts)</a></li>
            </ul>
        </aside>

        <main class="admin-content">
            <header class="admin-topbar">
                <button class="toggle-sidebar" id="sidebarToggle"><i class="fa-solid fa-bars"></i></button>
                <div class="topbar-right">
                    <div class="user-profile" id="userProfileDropdown" onclick="toggleProfileDropdown()">
                        <div class="user-avatar">A</div>
                        <span style="font-size: 0.9rem; font-weight: 500;">Super Admin</span>
                        <i class="fa-solid fa-chevron-down" style="font-size: 0.7rem;"></i>

                        <div class="dropdown-menu" id="profileDropdown">
                            <a href="user_profile.html" class="dropdown-item"><i class="fa-solid fa-user-cog"
                                    style="margin-right: 8px;"></i> ตั้งค่าผู้ใช้งาน</a>
                            <div class="dropdown-divider"></div>
                            <a href="index.html" class="dropdown-item" style="color: #dc3545;"><i
                                    class="fa-solid fa-sign-out-alt" style="margin-right: 8px;"></i> ออกจากระบบ</a>
                        </div>
                    </div>
                </div>
            </header>

            <div class="dashboard-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h1 class="page-title" style="margin-bottom: 0;">คลังสื่อ (Media Library)</h1>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-login"
                            style="width: auto; padding: 10px 15px; background-color: #6c757d; border-color: #6c757d;"
                            onclick="navigateUp()"><i class="fa-solid fa-arrow-up"></i> กลับ</button>
                        <button class="btn-login" style="width: auto; padding: 10px 15px;" onclick="createFolder()"><i
                                class="fa-solid fa-folder-plus"></i> สร้างโฟลเดอร์</button>
                        <button class="btn-login" style="width: auto; padding: 10px 15px; background-color: #007bff;"
                            onclick="uploadFile()"><i class="fa-solid fa-upload"></i> อัปโหลด</button>
                    </div>
                </div>

                <div class="widget-card">
                    <div
                        style="background: #f8f9fa; padding: 10px; border-bottom: 1px solid #ddd; margin-bottom: 15px; border-radius: 4px;">
                        <i class="fa-solid fa-location-dot" style="color: #666; margin-right: 5px;"></i> <span
                            id="breadcrumb" style="font-weight: 500; color: #333;">assets</span>
                    </div>

                    <div id="fileList"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px;">
                        <!-- Content will be generated by JS -->
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script>
        const sidebarToggle = document.getElementById('sidebarToggle');
        const adminContainer = document.querySelector('.admin-container');
        sidebarToggle.addEventListener('click', () => { adminContainer.classList.toggle('sidebar-open'); });

        function toggleProfileDropdown() {
            document.getElementById('profileDropdown').classList.toggle('show');
        }

        window.onclick = function (event) {
            if (!event.target.closest('.user-profile')) {
                const d = document.getElementById('profileDropdown');
                if (d && d.classList.contains('show')) d.classList.remove('show');
            }
        }

        // --- API Integration ---
        const token = localStorage.getItem('cms_token');
        if (!token) window.location.href = 'login.html';

        // Path Management (Stores IDs and Names)
        let pathStack = [{ id: 0, name: 'assets' }];

        async function fetchMedia(parentId = 0) {
            try {
                const res = await fetch(`/api/media?parent_id=${parentId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const items = await res.json();
                renderMedia(items);
            } catch (e) { console.error(e); }
        }

        function getCurrentFolderId() {
            return pathStack[pathStack.length - 1].id;
        }

        function renderMedia(items) {
            const container = document.getElementById('fileList');
            const breadcrumb = document.getElementById('breadcrumb');
            container.innerHTML = '';

            // Update Breadcrumb
            breadcrumb.innerHTML = pathStack.map((folder, index) => {
                const isLast = index === pathStack.length - 1;
                const style = isLast ? 'color: #333; font-weight: 600;' : 'color: var(--cms-primary); cursor: pointer; text-decoration: underline;';
                const onclick = isLast ? '' : `onclick="navigateToIndex(${index})"`;
                return `<span ${onclick} style="${style}">${folder.name}</span>`;
            }).join(' <span style="color:#999; margin:0 5px;">/</span> ');

            if (items.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #999; padding: 30px;">โฟลเดอร์ว่างเปล่า</div>';
                return;
            }

            items.forEach(item => {
                const isFolder = item.is_folder;
                const icon = isFolder ? 'fa-folder' : 'fa-image';
                const color = isFolder ? '#ffc107' : '#17a2b8';

                // For files, ideally show thumbnail if image, but icon is fine for now
                let thumbnailHtml = `<i class="fa-solid ${icon}" style="font-size: 3rem; color: ${color};"></i>`;
                if (!isFolder && ['.jpg', '.jpeg', '.png', '.gif', '.webp'].includes(item.file_type.toLowerCase())) {
                    // Using proxy or direct path if served
                    thumbnailHtml = `<img src="${item.file_path}" style="max-width:100%; max-height:100%; object-fit:contain;">`;
                }

                const card = document.createElement('div');
                card.style.cssText = 'border: 1px solid #eee; padding: 10px; border-radius: 4px; text-align: center; position: relative; background: #fff; transition: box-shadow 0.2s;';
                card.onmouseover = () => card.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
                card.onmouseout = () => card.style.boxShadow = 'none';

                const onClickAction = isFolder ? `enterFolder(${item.id}, '${item.file_name}')` : `viewFile('${item.file_path}')`;

                let html = `
                    <div style="height: 80px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; cursor: pointer;" onclick="${onClickAction}">
                        ${thumbnailHtml}
                    </div>
                    <div style="font-size: 0.9rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-bottom: 8px;" title="${item.file_name}">${item.file_name}</div>
                    <div style="display: flex; justify-content: center; gap: 5px;">
                        <!-- Rename not implemented in this minimal API version -->
                        <button onclick="deleteItem(${item.id}, '${item.file_name}')" style="border: none; background: #fee; padding: 4px 8px; border-radius: 3px; cursor: pointer; color: #dc3545;" title="ลบ"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                card.innerHTML = html;
                container.appendChild(card);
            });
        }

        function enterFolder(id, name) {
            pathStack.push({ id, name });
            fetchMedia(id);
        }

        function navigateToIndex(index) {
            pathStack = pathStack.slice(0, index + 1);
            fetchMedia(getCurrentFolderId());
        }

        function navigateUp() {
            if (pathStack.length > 1) {
                pathStack.pop();
                fetchMedia(getCurrentFolderId());
            } else {
                alert("คุณอยู่ที่โฟลเดอร์ราก (Root) แล้ว");
            }
        }

        async function createFolder() {
            const name = prompt("กรุณาใส่ชื่อโฟลเดอร์ใหม่:");
            if (name) {
                try {
                    const res = await fetch('/api/media/folder', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ name, parent_id: getCurrentFolderId() })
                    });
                    if (res.ok) fetchMedia(getCurrentFolderId());
                    else alert('Error creating folder');
                } catch (e) { console.error(e); }
            }
        }

        async function uploadFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.onchange = async e => {
                const files = e.target.files;
                if (files && files.length > 0) {
                    let successCount = 0;

                    const promises = Array.from(files).map(async file => {
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('parent_id', getCurrentFolderId());

                        try {
                            const res = await fetch('/api/media/upload', {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${token}` },
                                body: formData
                            });
                            if (res.ok) successCount++;
                        } catch (e) { console.error(e); }
                    });

                    await Promise.all(promises);

                    if (successCount > 0) {
                        fetchMedia(getCurrentFolderId());
                    } else {
                        alert('Upload failed');
                    }
                }
            };
            input.click();
        }

        async function deleteItem(id, name) {
            if (confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบ "${name}"?`)) {
                try {
                    const res = await fetch(`/api/media/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) fetchMedia(getCurrentFolderId());
                    else alert('Delete failed');
                } catch (e) { console.error(e); }
            }
        }

        function renameItem() {
            alert('Feature not available in this version');
        }

        function viewFile(path) {
            // Optional: Open in new tab
            window.open(path, '_blank');
        }

        // Initialize
        fetchMedia(0);
    </script>
</body>

</html>