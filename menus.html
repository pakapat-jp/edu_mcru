<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการเมนู (Menus) - CMS Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="admin_style.css">
</head>

<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="admin-sidebar" id="sidebar"></aside>

        <main class="admin-content">
            <header class="admin-topbar">
                <button class="toggle-sidebar" id="sidebarToggle"><i class="fa-solid fa-bars"></i></button>
                <div class="topbar-right">
                    <div class="user-profile" id="userProfileDropdown" onclick="toggleProfileDropdown()">
                        <div class="user-avatar">A</div>
                        <span style="font-size: 0.9rem; font-weight: 500;">Super Admin</span>
                        <i class="fa-solid fa-chevron-down" style="font-size: 0.7rem;"></i>

                        <div class="dropdown-menu" id="profileDropdown">
                            <a href="user_profile.html" class="dropdown-item"><i class="fa-solid fa-user-cog"
                                    style="margin-right: 8px;"></i> ตั้งค่าผู้ใช้งาน</a>
                            <div class="dropdown-divider"></div>
                            <a href="index.html" class="dropdown-item" style="color: #dc3545;"><i
                                    class="fa-solid fa-sign-out-alt" style="margin-right: 8px;"></i> ออกจากระบบ</a>
                        </div>
                    </div>
                </div>
            </header>

            <script>
                function toggleProfileDropdown() {
                    document.getElementById('profileDropdown').classList.toggle('show');
                }

                // Close dropdowns if clicked outside
                window.onclick = function (event) {
                    if (!event.target.closest('.user-profile')) {
                        const dropdowns = document.getElementsByClassName("dropdown-menu");
                        for (let i = 0; i < dropdowns.length; i++) {
                            const openDropdown = dropdowns[i];
                            if (openDropdown.classList.contains('show')) {
                                openDropdown.classList.remove('show');
                            }
                        }
                    }

                    // Existing modal close logic
                    const menuModal = document.getElementById('menuModal');
                    const articleModal = document.getElementById('articleModal');
                    if (event.target == menuModal) closeModal();
                    if (event.target == articleModal && typeof closeArticlePicker === 'function') closeArticlePicker();
                }
            </script>

            <div class="dashboard-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h1 class="page-title" style="margin-bottom: 0;">จัดการเมนูหลัก (Main Menu)</h1>
                    <button class="btn-login" style="width: auto; padding: 10px 20px;" onclick="openModal()"><i
                            class="fa-solid fa-plus"></i>
                        เพิ่มรายการเมนู</button>
                </div>

                <div class="widget-card">
                    <table class="cms-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">ลำดับ</th>
                                <th>ชื่อเมนู</th>
                                <th>ลิงก์ (URL)</th>
                                <th>ประเภท</th>
                                <th>สถานะ</th>
                                <th>เครื่องมือ</th>
                            </tr>
                        </thead>
                        <tbody id="menuTableBody">
                            <!-- Generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Menu Modal -->
    <div id="menuModal"
        style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div
            style="background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 600px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: fadeIn 0.3s;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <h3 style="margin: 0;" id="modalTitle">เพิ่มรายการเมนู</h3>
                <span onclick="closeModal()"
                    style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
            </div>

            <form id="menuForm" onsubmit="saveMenu(event)">
                <input type="hidden" id="menuId">

                <!-- Title & Slug -->
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">ชื่อเมนู (Title) <span
                            style="color: red;">*</span></label>
                    <input type="text" id="menuTitle" required
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                        onkeyup="generateSlug(this.value)">
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Slug (Alias)</label>
                    <input type="text" id="menuSlug" placeholder="auto-generated-from-title"
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9;">
                    <div style="font-size: 0.8rem; color: #888; margin-top: 3px;">ใช้ภาษาอังกฤษตัวพิมพ์เล็กและตัวเลข
                        (a-z, 0-9) คั่นด้วยขีดกลาง (-)</div>
                </div>

                <!-- Type & Parent -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">ประเภทเมนู (Menu
                            Type)</label>
                        <select id="menuType"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                            onchange="toggleUrlField()">
                            <option value="link">ลิงก์เมนู (Menu Link)</option>
                            <option value="heading">หัวข้อเมนู (Menu Heading)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">เมนูหลัก (Parent
                            Item)</label>
                        <select id="menuParent"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="0">- ไม่มี (เป็นเมนูหลัก) -</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>

                <!-- URL Section (Conditional) -->
                <div id="urlSection" class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">ลิงก์ (URL) <span
                            style="color: red;">*</span></label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="menuUrl"
                            style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <button type="button" onclick="openArticlePicker()"
                            style="background: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; white-space: nowrap;"><i
                                class="fa-solid fa-list"></i> เลือกรายการ</button>
                    </div>
                </div>

                <!-- Status removed from form, default to 1 on create, toggle in list -->

                <div style="text-align: right; border-top: 1px solid #eee; padding-top: 20px;">
                    <button type="button" onclick="closeModal()"
                        style="background: #ccc; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">ยกเลิก</button>
                    <button type="submit"
                        style="background:var(--cms-primary); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Article Picker Modal -->
    <div id="articleModal"
        style="display: none; position: fixed; z-index: 1100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
        <div
            style="background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 500px; border-radius: 8px; max-height: 70vh; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">เลือกรายการ (Select Link)</h3>
                <span onclick="closeArticlePicker()"
                    style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
            </div>
            <div style="overflow-y: auto; flex: 1; border: 1px solid #eee; border-radius: 4px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #eee; background: #f9f9f9;">
                            <th style="padding: 10px; text-align: left;">ชื่อ (Name)</th>
                            <th style="padding: 10px; text-align: left;">หมวดหมู่ (Category)</th>
                            <th style="padding: 10px; text-align: right;">เลือก</th>
                        </tr>
                    </thead>
                    <tbody id="articleList">
                        <!-- JS Generated -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const sidebarToggle = document.getElementById('sidebarToggle');
        const adminContainer = document.querySelector('.admin-container');
        sidebarToggle.addEventListener('click', () => { adminContainer.classList.toggle('sidebar-open'); });

        // Auth
        const token = localStorage.getItem('cms_token');
        if (!token) window.location.href = 'login.html';

        let menuItems = [];
        let articles = []; // Loaded from news for picker

        // --- API Functions ---
        async function loadMenus() {
            try {
                const res = await fetch('/api/menus', { headers: { 'Authorization': `Bearer ${token}` } });
                menuItems = await res.json();
                renderMenus();
            } catch (e) { console.error(e); }
        }

        async function loadArticlesForPicker() {
            try {
                const res = await fetch('/api/news', { headers: { 'Authorization': `Bearer ${token}` } });
                articles = await res.json(); // Reuses global articles
            } catch (e) { console.error(e); }
        }

        async function saveMenu(e) {
            e.preventDefault();
            const id = document.getElementById('menuId').value;
            const title = document.getElementById('menuTitle').value;
            const slug = document.getElementById('menuSlug').value;
            const type = document.getElementById('menuType').value;
            const parent_id = document.getElementById('menuParent').value;
            const url = document.getElementById('menuUrl').value;

            const body = { title, slug, type, parent_id, url };

            try {
                const method = id ? 'PUT' : 'POST';
                const endpoint = id ? `/api/menus/${id}` : '/api/menus';

                const res = await fetch(endpoint, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    closeModal();
                    loadMenus();
                } else {
                    alert('Error saving menu');
                }
            } catch (e) { console.error(e); }
        }

        async function toggleStatus(id) {
            const item = menuItems.find(m => m.id === id);
            if (!item) return;
            const newStatus = item.status === 1 ? 0 : 1;

            try {
                await fetch(`/api/menus/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ status: newStatus })
                });
                loadMenus();
            } catch (e) { console.error(e); }
        }

        async function deleteMenu(id) {
            if (!confirm('ยืนยันการลบ?')) return;
            try {
                await fetch(`/api/menus/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                loadMenus();
            } catch (e) { console.error(e); }
        }

        async function updateOrder(id, order) {
            await fetch(`/api/menus/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ sort_order: order })
            });
        }

        async function moveUp(id) {
            const currentItem = menuItems.find(m => m.id === id);
            if (!currentItem) return;

            // Find siblings sorted by order
            const siblings = menuItems
                .filter(m => m.parent_id === currentItem.parent_id)
                .sort((a, b) => a.sort_order - b.sort_order);

            const currentIndex = siblings.findIndex(m => m.id === id);
            if (currentIndex > 0) {
                const prevItem = siblings[currentIndex - 1];

                // Swap orders
                await updateOrder(currentItem.id, prevItem.sort_order);
                await updateOrder(prevItem.id, currentItem.sort_order);

                loadMenus();
            }
        }

        async function moveDown(id) {
            const currentItem = menuItems.find(m => m.id === id);
            if (!currentItem) return;

            const siblings = menuItems
                .filter(m => m.parent_id === currentItem.parent_id)
                .sort((a, b) => a.sort_order - b.sort_order);

            const currentIndex = siblings.findIndex(m => m.id === id);
            if (currentIndex < siblings.length - 1) {
                const nextItem = siblings[currentIndex + 1];

                // Swap orders
                await updateOrder(currentItem.id, nextItem.sort_order);
                await updateOrder(nextItem.id, currentItem.sort_order);

                loadMenus();
            }
        }

        // --- Render & UI Logic ---

        function renderMenus() {
            const tbody = document.getElementById('menuTableBody');
            tbody.innerHTML = '';

            // Helper to get children
            const getChildren = (parentId) => menuItems.filter(m => m.parent_id === parentId).sort((a, b) => a.sort_order - b.sort_order);

            let globalIndex = 0;

            const renderRowRecursive = (parentId, level) => {
                const children = getChildren(parentId);
                children.forEach((item, index) => {
                    globalIndex++;
                    const tr = document.createElement('tr');

                    // Check if this is Home menu (usually slug 'home' or ID 1, let's use slug check for robustness)
                    const isHome = item.slug === 'home';
                    // Check if previous item was Home (to disable shifting above it)
                    const prevIsHome = index > 0 && children[index - 1].slug === 'home';

                    let typeBadge = item.type === 'heading'
                        ? '<span style="font-size: 0.8rem; background: #d4edda; color: #155724; padding: 2px 6px; border-radius: 3px;">Heading</span>'
                        : '<span style="font-size: 0.8rem; background: #e2e3e5; color: #383d41; padding: 2px 6px; border-radius: 3px;">Link</span>';

                    const statusBadge = item.status === 1
                        ? `<span onclick="toggleStatus(${item.id})" style="color: #28a745; cursor: pointer;"><i class="fa-solid fa-check-circle"></i> แสดงผล</span>`
                        : `<span onclick="toggleStatus(${item.id})" style="color: #dc3545; cursor: pointer;"><i class="fa-solid fa-times-circle"></i> ซ่อน</span>`;

                    // Indentation
                    let prefix = '';
                    if (level > 0) {
                        prefix = `<span style="color: #ccc; margin-left: ${level * 20}px;">↳</span> `;
                    }

                    // Button Logic
                    const canMoveUp = !isHome && !prevIsHome && index > 0;
                    const canMoveDown = !isHome && index < children.length - 1;
                    const canDelete = !isHome;

                    tr.innerHTML = `
                        <td>${item.sort_order}</td>
                        <td style="font-weight: 500;">${prefix}${item.title} ${isHome ? '<span style="font-size:0.7em; color:#888; margin-left:5px;">(Fixed)</span>' : ''}</td>
                        <td style="color: #666; font-size: 0.9rem;">${item.type === 'heading' ? '-' : item.url}</td>
                        <td>${typeBadge}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div style="display:flex; gap:5px;">
                                <button onclick="moveUp(${item.id})" style="background:${canMoveUp ? '#fff3cd' : '#eee'}; border:none; border-radius:4px; width:30px; height:30px; cursor:${canMoveUp ? 'pointer' : 'not-allowed'};" title="Move Up" ${!canMoveUp ? 'disabled' : ''}><i class="fa-solid fa-arrow-up" style="color:${canMoveUp ? '#000' : '#aaa'}"></i></button>
                                <button onclick="moveDown(${item.id})" style="background:${canMoveDown ? '#fff3cd' : '#eee'}; border:none; border-radius:4px; width:30px; height:30px; cursor:${canMoveDown ? 'pointer' : 'not-allowed'};" title="Move Down" ${!canMoveDown ? 'disabled' : ''}><i class="fa-solid fa-arrow-down" style="color:${canMoveDown ? '#000' : '#aaa'}"></i></button>
                                <button onclick="editMenu(${item.id})" style="background:#f0f0f0; border:none; border-radius:4px; width:30px; height:30px; cursor:pointer;"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="deleteMenu(${item.id})" style="background:${canDelete ? '#fee' : '#eee'}; border:none; border-radius:4px; width:30px; height:30px; cursor:${canDelete ? 'pointer' : 'not-allowed'}; color:${canDelete ? '#dc3545' : '#aaa'};" ${!canDelete ? 'disabled' : ''}><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);

                    // Recursive call for next level
                    renderRowRecursive(item.id, level + 1);
                });
            };

            // Start rendering from root
            renderRowRecursive(0, 0);
        }

        // Modal & Form Helpers (Mostly reused mock logic but updated for API data)
        function generateSlug(val) {
            document.getElementById('menuSlug').value = val.toLowerCase().replace(/ /g, '-').replace(/[^\w-]+/g, '');
        }

        function toggleUrlField() {
            const type = document.getElementById('menuType').value;
            const urlSection = document.getElementById('urlSection');
            if (type === 'heading') {
                urlSection.style.display = 'none';
                document.getElementById('menuUrl').value = '#';
            } else {
                urlSection.style.display = 'block';
                if (document.getElementById('menuUrl').value === '#') document.getElementById('menuUrl').value = '';
            }
        }

        function renderParentOptions(excludeId = null) {
            const select = document.getElementById('menuParent');
            select.innerHTML = '<option value="0">- ไม่มี (เป็นเมนูหลัก) -</option>';

            // Helper to find children
            const getChildren = (parentId) => menuItems.filter(m => m.parent_id === parentId).sort((a, b) => a.sort_order - b.sort_order);

            // Recursive function to render options
            const renderOptionsRecursively = (parentId, level) => {
                const children = getChildren(parentId);
                children.forEach(item => {
                    // Prevent selecting self as parent (cycle)
                    if (item.id === excludeId) return;

                    const option = document.createElement('option');
                    option.value = item.id;
                    // Visual indentation
                    const prefix = '&nbsp;&nbsp;&nbsp;'.repeat(level);
                    option.innerHTML = (level > 0 ? prefix + '↳ ' : '') + item.title;
                    select.appendChild(option);

                    // Render children of this item (next level)
                    renderOptionsRecursively(item.id, level + 1);
                });
            };

            // Start with root items (parent_id 0)
            renderOptionsRecursively(0, 0);
        }

        function openModal(id = null) {
            const modal = document.getElementById('menuModal');
            const form = document.getElementById('menuForm');
            renderParentOptions(id);

            if (id) {
                const item = menuItems.find(m => m.id === id);
                document.getElementById('modalTitle').innerText = 'แก้ไขรายการเมนู';
                document.getElementById('menuId').value = item.id;
                document.getElementById('menuTitle').value = item.title;
                document.getElementById('menuSlug').value = item.slug || '';
                document.getElementById('menuType').value = item.type;
                document.getElementById('menuParent').value = item.parent_id;
                document.getElementById('menuUrl').value = item.url;
            } else {
                document.getElementById('modalTitle').innerText = 'เพิ่มรายการเมนู';
                form.reset();
                document.getElementById('menuId').value = '';
                document.getElementById('menuType').value = 'link'; // Reset
                document.getElementById('menuParent').value = 0;
            }
            toggleUrlField();
            modal.style.display = 'block';
        }

        function closeModal() { document.getElementById('menuModal').style.display = 'none'; }
        function editMenu(id) { openModal(id); }

        // Article Picker
        const projectPages = [
            { title: 'หน้าหลัก (Home)', url: 'index.html', category: 'เมนู' },
            { title: 'ประวัติความเป็นมา (History)', url: 'history.html', category: 'เมนู' },
            { title: 'วิสัยทัศน์ (Vision)', url: 'vision.html', category: 'เมนู' },
            { title: 'โครงสร้างองค์กร (Structure)', url: 'structure.html', category: 'เมนู' },
            { title: 'ผู้บริหาร (Executive Committee)', url: 'executive_committee.html', category: 'เมนู' },
            { title: 'ทำเนียบคณบดี (Dean\'s List)', url: 'deans_list.html', category: 'เมนู' },
            { title: 'คณะกรรมการประจำคณะ (Board)', url: 'board.html', category: 'เมนู' },
            { title: 'หลักสูตร (Courses)', url: 'courses.html', category: 'เมนู' },
            { title: 'โรงเรียนสาธิตฯ (Thantawan School)', url: 'thantawan_school.html', category: 'เมนู' },
            { title: 'โครงการพัฒนาครู (Teacher Pro Dev)', url: 'teacher_pro_dev.html', category: 'เมนู' },
            { title: 'บริการวิชาการ (Services)', url: 'services.html', category: 'เมนู' },
            { title: 'ประกันคุณภาพ (QA)', url: 'qa.html', category: 'เมนู' },
            { title: 'ผลการดำเนินงาน (Operation Results)', url: 'operation_results.html', category: 'เมนู' },
            { title: 'แผนการดำเนินงาน (Operation Plan)', url: 'operation_plan.html', category: 'เมนู' },
            { title: 'ITA', url: 'ita.html', category: 'เมนู' },
            { title: 'เอกสารเผยแพร่ (Documents)', url: 'documents.html', category: 'เมนู' },
            { title: 'บุคลากร (Personnel)', url: 'personnel.html', category: 'เมนู' },
            { title: 'ติดต่อเรา (Contact)', url: 'contact.html', category: 'เมนู' }
        ];

        function openArticlePicker() {
            const modal = document.getElementById('articleModal');
            const list = document.getElementById('articleList');
            list.innerHTML = '';

            // Allow loading if likely empty
            if (articles.length === 0) loadArticlesForPicker();

            // Timeout to allow load or check
            setTimeout(() => {
                // Merge static pages and articles
                const allItems = [
                    ...projectPages,
                    ...articles.map(art => ({
                        title: art.title,
                        url: `news-detail.html?id=${art.id}`,
                        category: art.category_name || 'บทความ (Article)' // Use category from API or default
                    }))
                ];

                if (allItems.length === 0) {
                    list.innerHTML = '<tr><td colspan="3" style="padding: 20px; text-align: center;">ไม่พบข้อมูล</td></tr>';
                    return;
                }

                allItems.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid #eee';
                    tr.innerHTML = `
                        <td style="padding: 10px;">${item.title}</td>
                        <td style="padding: 10px;"><span style="font-size: 0.85rem; padding: 2px 6px; background: #e9ecef; border-radius: 4px; color: #495057;">${item.category}</span></td>
                        <td style="padding: 10px; text-align: right;">
                            <button type="button" onclick="selectArticle('${item.url}')" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">เลือก</button>
                        </td>
                    `;
                    list.appendChild(tr);
                });
            }, 500); // Simple wait

            modal.style.display = 'block';
        }

        function closeArticlePicker() { document.getElementById('articleModal').style.display = 'none'; }
        function selectArticle(url) {
            document.getElementById('menuUrl').value = url;
            closeArticlePicker();
        }

        // Init
        loadMenus();

        window.onclick = function (event) {
            const menuModal = document.getElementById('menuModal');
            const articleModal = document.getElementById('articleModal');
            if (event.target == menuModal) closeModal();
            if (event.target == articleModal) closeArticlePicker();

            if (!event.target.closest('.user-profile')) {
                const d = document.getElementById('profileDropdown');
                if (d && d.classList.contains('show')) d.classList.remove('show');
            }
        }
    </script>
    <script src="js/global-loader.js"></script>
</body>

</html>