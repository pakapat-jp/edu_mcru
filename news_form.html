<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เพิ่มบทความใหม่ (New Article) - CMS Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="admin_style.css">
    <!-- CKEditor 5 Local Custom Build (Styles Injected) -->
    <script src="js/ckeditor5/ckeditor5.umd.js"></script>
    <script src="js/ckeditor5/translations/th.js"></script>
    <script>
        // Compatibility check for global variable
        if (window.CKEditor5 && !window.CKEDITOR) {
            window.CKEDITOR = window.CKEditor5;
        }
    </script>

    <style>
        /* Toolbar Actions */
        .toolbar-actions {
            display: flex;
            gap: 10px;
        }

        .btn-toolbar {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
        }

        .btn-save {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }

        .btn-save:hover {
            background-color: #218838;
        }

        .btn-cancel {
            background-color: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .btn-cancel:hover {
            background-color: #c82333;
        }

        /* Form Layout */
        .article-form-grid {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        @media (max-width: 992px) {
            .article-form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Editor Container */
        .editor-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            padding: 10px;
        }

        #editor {
            width: 100%;
            min-height: 400px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
        }

        /* Accordion/Panel Styling */
        .panel {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .panel-header {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            font-weight: 500;
        }

        .panel-body {
            padding: 15px;
        }

        /* Tabs Styling */
        .nav-tabs-wrapper {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            gap: 5px;
            padding: 0 5px;
        }

        .nav-tabs {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            gap: 5px;
            flex-wrap: wrap;
        }

        .nav-tab-item {
            position: relative;
        }

        .nav-tab-link {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            background: #f1f3f5;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            text-decoration: none;
            color: #6c757d;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-tab-link:hover {
            background: #e9ecef;
        }

        .nav-tab-link.active {
            background: #fff;
            color: #2255a4;
            font-weight: 500;
            border-bottom: 1px solid #fff;
            position: relative;
            z-index: 2;
        }

        .nav-tab-link input {
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: inherit;
            font-weight: inherit;
            color: inherit;
            width: 80px;
            outline: none;
        }

        .btn-add-tab {
            background: #e9ecef;
            border: 1px solid #ddd;
            color: #6c757d;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: 0.2s;
        }

        .btn-add-tab:hover {
            background: #dde2e6;
            color: #495057;
        }

        .tab-close {
            margin-left: 8px;
            font-size: 12px;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: #adb5bd;
            transition: 0.2s;
        }

        .tab-close:hover {
            background: #dc3545;
            color: #fff;
        }

        /* Make editor container connect with tabs */
        .editor-container.with-tabs {
            border-top-left-radius: 0;
            margin-top: -1px;
            z-index: 1;
            position: relative;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }
    </style>
</head>

<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="admin-sidebar" id="sidebar"><!-- Loading Sidebar... --></aside>

        <main class="admin-content">
            <header class="admin-topbar">
                <button class="toggle-sidebar" id="sidebarToggle"><i class="fa-solid fa-bars"></i></button>
                <div class="topbar-right">
                    <div class="user-profile" id="userProfileDropdown" onclick="toggleProfileDropdown()">
                        <div class="user-avatar">A</div>
                        <span style="font-size: 0.9rem; font-weight: 500;">Super Admin</span>
                        <i class="fa-solid fa-chevron-down" style="font-size: 0.7rem;"></i>

                        <div class="dropdown-menu" id="profileDropdown">
                            <a href="user_profile.html" class="dropdown-item"><i class="fa-solid fa-user-cog"
                                    style="margin-right: 8px;"></i> ตั้งค่าผู้ใช้งาน</a>
                            <div class="dropdown-divider"></div>
                            <a href="index.html" class="dropdown-item" style="color: #dc3545;"><i
                                    class="fa-solid fa-sign-out-alt" style="margin-right: 8px;"></i> ออกจากระบบ</a>
                        </div>
                    </div>
                </div>
            </header>

            <div class="dashboard-container">
                <!-- Toolbar -->
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #fff; padding: 10px 20px; border-radius: 5px; border: 1px solid #e0e0e0;">
                    <h1 class="page-title" style="margin-bottom: 0; font-size: 1.2rem;">บทความ: เพิ่มข้อมูลใหม่</h1>
                    <div class="toolbar-actions">
                        <button type="button" class="btn-toolbar btn-save" onclick="saveNews(false)"><i
                                class="fa-solid fa-check"></i> บันทึก</button>
                        <button type="button" class="btn-toolbar btn-save" onclick="saveNews(true)"><i
                                class="fa-solid fa-floppy-disk"></i>
                            บันทึกและปิด</button>
                        <a href="news_content.html" class="btn-toolbar btn-cancel"><i class="fa-solid fa-xmark"></i>
                            ยกเลิก</a>
                    </div>
                </div>

                <form class="article-form-grid">
                    <!-- Left Column (Main Content) -->
                    <div class="left-col">
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label style="font-weight: 500; font-size: 1.1rem;">หัวข้อ (Title) <span
                                    style="color: red;">*</span></label>
                            <input type="text" id="titleInput" placeholder="ใส่หัวข้อบทความที่นี่..."
                                style="width: 100%; padding: 10px; font-size: 1.1rem; border: 1px solid #ccc; border-radius: 4px;">
                        </div>

                        <div class="form-group" style="margin-bottom: 20px;">
                            <label style="font-weight: 500;">Slug (Alias)</label>
                            <input type="text" placeholder="auto-generated-from-title"
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9;">
                            <div style="font-size: 0.85rem; color: #666; margin-top: 5px; font-style: italic;">
                                <i class="fa-solid fa-circle-info"></i> คำแนะนำ: ใช้ตัวอักษรภาษาอังกฤษตัวพิมพ์เล็ก
                                (a-z), ตัวเลข (0-9) และเครื่องหมายขีดกลาง (-) เท่านั้น ห้ามเว้นวรรค
                            </div>
                        </div>

                        <!-- TinyMCE-like Editor -->
                        <!-- Tabbed Editor -->
                        <div class="form-group">
                            <label style="font-weight: 500; margin-bottom: 5px; display: block;">รายละเอียด
                                (Details) <span style="color: red;">*</span></label>

                            <div class="editor-container">
                                <textarea id="editor"></textarea>
                            </div>
                        </div>

                    </div>

                    <!-- Right Column (Settings) -->
                    <div class="right-col">
                        <div class="panel">
                            <div class="panel-header">สถานะ & การเผยแพร่</div>
                            <div class="panel-body">
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px;">สถานะ</label>
                                    <select id="statusSelect"
                                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="1">เผยแพร่ (Published)</option>
                                        <option value="0">ไม่เผยแพร่ (Unpublished)</option>
                                        <option value="-1">ถังขยะ (Trashed)</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px;">หมวดหมู่</label>
                                    <select id="categoryIdSelect"
                                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">กำลังโหลด...</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px;">วันที่เผยแพร่</label>
                                    <input type="date" id="publishedDateInput"
                                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>

                            </div>
                        </div>

                        <div class="panel">
                            <div class="panel-header">รูปภาพหน้าปก (Cover Image)</div>
                            <div class="panel-body">
                                <div id="coverImageContainer"
                                    style="text-align: center; border: 2px dashed #ddd; padding: 20px; margin-bottom: 10px; border-radius: 4px;">
                                    <img id="imagePreview" src=""
                                        style="max-width: 100%; max-height: 200px; display: none; margin-bottom: 10px;">

                                    <div style="margin-top:10px; display:flex; gap:10px; justify-content:center;">
                                        <button type="button" onclick="openMediaModal('cover')" class="btn-toolbar"
                                            style="background:#f8f9fa; border:1px solid #ddd;"><i
                                                class="fa-solid fa-image"></i> เพิ่มรูปภาพ</button>
                                    </div>
                                    <input type="hidden" id="coverUrlInput">
                                </div>
                            </div>
                        </div>

                        <!-- Gallery Section -->
                        <div class="panel">
                            <div class="panel-header">อัลบั้มรูปภาพ (Gallery)</div>
                            <div class="panel-body">
                                <div style="margin-bottom: 10px; display:flex; gap:10px;">
                                    <button type="button" onclick="openMediaModal('gallery')"
                                        style="background: #f8f9fa; color: #333; border: 1px dashed #ccc; padding: 10px; flex:1; border-radius: 4px; cursor: pointer; text-align: center;">
                                        <i class="fa-solid fa-image"></i> เพิ่มรูปภาพ
                                    </button>
                                </div>
                                <div id="galleryPreviewContainer"
                                    style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;">
                                    <!-- Gallery items will appear here -->
                                </div>
                            </div>
                        </div>


                    </div>
                </form>

            </div>
        </main>
    </div>
    <!-- Media Library Modal -->
    <div id="mediaModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div
            style="background: #fff; width: 80%; height: 80%; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
            <div
                style="padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa;">
                <h3 style="margin: 0; margin-right: 20px;">เลือกรูปภาพ (Select Image)</h3>
                <button type="button" onclick="closeMediaModal()"
                    style="border: none; background: transparent; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>

            <div style="flex-grow: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div
                        style="background: #f1f3f5; padding: 8px 15px; border-radius: 4px; border: 1px solid #e9ecef; color: #555;">
                        <i class="fa-solid fa-folder-open" style="color: #6c757d; margin-right: 5px;"></i> Path: <span
                            id="modalBreadcrumb" style="font-weight: 500;">assets</span>
                    </div>
                    <div>
                        <button type="button" onclick="navigateUpModal()"
                            style="padding: 6px 12px; border: 1px solid #ddd; background: #fff; border-radius: 3px; cursor: pointer;"><i
                                class="fa-solid fa-arrow-up"></i> กลับ</button>
                    </div>
                </div>

                <div id="modalFileList"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px;">
                    <!-- Generated by JS -->
                </div>
            </div>

            <div style="padding: 15px 20px; border-top: 1px solid #eee; text-align: right; background: #f8f9fa;">
                <button type="button" onclick="closeMediaModal()"
                    style="padding: 8px 15px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; margin-right: 10px;">ยกเลิก</button>
                <button type="button" onclick="confirmModalSelection()" id="modalConfirmBtn"
                    style="padding: 8px 15px; border: 1px solid #28a745; background: #28a745; color: white; border-radius: 4px; cursor: pointer; display: none;">ยืนยันเลือกรูปภาพ</button>
            </div>
        </div>
    </div>

    <script>
        const sidebarToggle = document.getElementById('sidebarToggle');
        const adminContainer = document.querySelector('.admin-container');
        sidebarToggle.addEventListener('click', () => { adminContainer.classList.toggle('sidebar-open'); });

        function toggleProfileDropdown() {
            document.getElementById('profileDropdown').classList.toggle('show');
        }

        // Close dropdowns if clicked outside
        window.onclick = function (event) {
            if (!event.target.closest('.user-profile')) {
                const dropdowns = document.getElementsByClassName("dropdown-menu");
                for (let i = 0; i < dropdowns.length; i++) {
                    const openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }

            // Existing modal close logic (media modal)
            const mediaModal = document.getElementById('mediaModal');
            if (event.target == mediaModal) {
                mediaModal.style.display = 'none';
            }
        }

        // --- Editor Functions ---


        // Gallery State
        let currentGallery = []; // Array of URLs string

        // --- Custom Upload Adapter ---
        class MyUploadAdapter {
            constructor(loader) {
                // The file loader instance to use during the upload.
                this.loader = loader;
            }

            // Starts the upload process.
            upload() {
                return this.loader.file
                    .then(file => new Promise((resolve, reject) => {
                        this._initRequest();
                        this._initListeners(resolve, reject, file);
                        this._sendRequest(file);
                    }));
            }

            // Aborts the upload process.
            abort() {
                if (this.xhr) {
                    this.xhr.abort();
                }
            }

            // Initializes the XMLHttpRequest object using the URL passed to the constructor.
            _initRequest() {
                const xhr = this.xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/ckeditor/upload', true);
                xhr.responseType = 'json';
                // Add Authorization header
                const token = localStorage.getItem('cms_token');
                if (token) {
                    xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                }
            }

            // Initializes XMLHttpRequest listeners.
            _initListeners(resolve, reject, file) {
                const xhr = this.xhr;
                const loader = this.loader;
                const genericErrorText = `Couldn't upload file: ${file.name}.`;

                xhr.addEventListener('error', () => reject(genericErrorText));
                xhr.addEventListener('abort', () => reject());
                xhr.addEventListener('load', () => {
                    const response = xhr.response;

                    if (!response || response.error) {
                        return reject(response && response.error ? response.error.message : genericErrorText);
                    }

                    // If the upload is successful, resolve the upload promise with an object containing
                    // at least the "default" URL, pointing to the image on the server.
                    resolve({
                        default: response.url
                    });
                });

                if (xhr.upload) {
                    xhr.upload.addEventListener('progress', evt => {
                        if (evt.lengthComputable) {
                            loader.uploadTotal = evt.total;
                            loader.uploaded = evt.loaded;
                        }
                    });
                }
            }

            // Prepares the data and sends the request.
            _sendRequest(file) {
                const data = new FormData();
                data.append('upload', file);
                this.xhr.send(data);
            }
        }

        function MyCustomUploadAdapterPlugin(editor) {
            editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
                // Configure the URL to the upload script in your back-end here!
                return new MyUploadAdapter(loader);
            };
        }

        // --- Dynamic Tab Logic ---
        function addNewTab(name = "ข้อมูลทั่วไป") {
            return new Promise((resolve) => {
                tabCounter++;
                const id = tabCounter;

                // 1. Create Tab Item
                const tabsList = document.getElementById('articleTabs');
                const li = document.createElement('li');
                li.className = 'nav-tab-item';
                li.id = `tabItem_${id}`;

                const link = document.createElement('a');
                link.className = 'nav-tab-link';

                // Editable Title Span
                const titleSpan = document.createElement('span');
                titleSpan.innerText = name;
                titleSpan.ondblclick = function (e) {
                    e.stopPropagation();
                    const currentText = this.innerText;
                    const input = document.createElement('input');
                    input.value = currentText;
                    input.onclick = (e) => e.stopPropagation();
                    input.onblur = function () {
                        titleSpan.innerText = this.value || "Tab";
                        titleSpan.style.display = 'inline';
                        input.remove();
                    };
                    input.onkeydown = function (e) {
                        if (e.key === 'Enter') this.blur();
                    };
                    this.style.display = 'none';
                    link.insertBefore(input, closeBtn);
                    input.focus();
                };

                const closeBtn = document.createElement('span');
                closeBtn.className = 'tab-close';
                closeBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                closeBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm('ต้องการลบแท็บนี้ใช่หรือไม่?')) {
                        deleteTab(id);
                    }
                };

                link.appendChild(titleSpan);
                link.appendChild(closeBtn);

                link.onclick = (e) => {
                    if (e.target.tagName !== 'INPUT' && !e.target.closest('.tab-close')) {
                        switchTab(id);
                    }
                };

                li.appendChild(link);
                tabsList.appendChild(li);

                // 2. Create Tab Pane
                const contentContainer = document.getElementById('tabContentContainer');
                const pane = document.createElement('div');
                pane.className = 'tab-pane';
                pane.id = `tabPane_${id}`;
                pane.dataset.tab = id;

                // Create Textarea for CKEditor
                const textarea = document.createElement('textarea');
                textarea.id = `editor_${id}`;
                pane.appendChild(textarea);

                contentContainer.appendChild(pane);

                // 3. Make pane visible BEFORE initializing CKEditor to prevent rendering issues
                switchTab(id);

                // Initialize CKEditor
                CKEDITOR.ClassicEditor.create(document.querySelector(`#editor_${id}`), {
                    // https://ckeditor.com/docs/ckeditor5/latest/features/general-html-support.html#enabling-all-html-features
                    htmlSupport: {
                        allow: [
                            {
                                name: /.*/,
                                attributes: true,
                                classes: true,
                                styles: true
                            }
                        ]
                    },
                    toolbar: {
                        items: [
                            'sourceEditing', '|',
                            'heading', '|',
                            'bold', 'italic', 'strikethrough', 'underline', 'code', 'subscript', 'superscript', 'removeFormat', '|',
                            'bulletedList', 'numberedList', 'todoList', '|',
                            'outdent', 'indent', '|',
                            'undo', 'redo',
                            '-',
                            'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor', 'highlight', '|',
                            'alignment', '|',
                            'link', 'uploadImage', 'blockQuote', 'insertTable', 'mediaEmbed', 'codeBlock', 'htmlEmbed', '|',
                            'specialCharacters', 'horizontalLine', 'pageBreak', '|',
                            'textPartLanguage', '|',
                        ],
                        shouldNotGroupWhenFull: true
                    },
                    // Changing the language of the interface requires loading the language file using the <script> tag.
                    // language: 'th',
                    list: {
                        properties: {
                            styles: true,
                            startIndex: true,
                            reversed: true
                        }
                    },
                    // https://ckeditor.com/docs/ckeditor5/latest/features/headings.html#configuration
                    heading: {
                        options: [
                            { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                            { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                            { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                            { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' },
                            { model: 'heading4', view: 'h4', title: 'Heading 4', class: 'ck-heading_heading4' },
                            { model: 'heading5', view: 'h5', title: 'Heading 5', class: 'ck-heading_heading5' },
                            { model: 'heading6', view: 'h6', title: 'Heading 6', class: 'ck-heading_heading6' }
                        ]
                    },
                    // https://ckeditor.com/docs/ckeditor5/latest/features/font.html#configuring-the-font-family-feature
                    fontFamily: {
                        options: [
                            'default',
                            'Kanit, Arial, sans-serif',
                            'Arial, Helvetica, sans-serif',
                            'Courier New, Courier, monospace',
                            'Georgia, serif',
                            'Lucida Sans Unicode, Lucida Grande, sans-serif',
                            'Tahoma, Geneva, sans-serif',
                            'Times New Roman, Times, serif',
                            'Trebuchet MS, Helvetica, sans-serif',
                            'Verdana, Geneva, sans-serif'
                        ],
                        supportAllValues: true
                    },
                    // https://ckeditor.com/docs/ckeditor5/latest/features/font.html#configuring-the-font-size-feature
                    fontSize: {
                        options: [10, 12, 14, 'default', 18, 20, 22],
                        supportAllValues: true
                    },
                    // Be careful with adding plugins that might not be in the build
                    removePlugins: [
                        'CKBox',
                        'CKFinder',
                        'EasyImage',
                        'RealTimeCollaborativeComments',
                        'RealTimeCollaborativeTrackChanges',
                        'RealTimeCollaborativeRevisionHistory',
                        'PresenceList',
                        'Comments',
                        'TrackChanges',
                        'TrackChangesData',
                        'RevisionHistory',
                        'Pagination',
                        'WProofreader',
                        'MathType',
                        'SlashCommand',
                        'Template',
                        'DocumentOutline',
                        'FormatPainter',
                        'TableOfContents'
                    ],
                    mediaEmbed: {
                        previewsInData: true
                    },
                    extraPlugins: [MyCustomUploadAdapterPlugin]
                })
                    .then(editor => {
                        editors[id] = editor;
                        editor.setData('');
                        resolve(id);
                    })
                    .catch(error => {
                        console.error(error);
                        resolve(null);
                    });
            });
        }

        function switchTab(id) {
            if (activeTabId === id) return;

            // Deactivate current
            if (activeTabId) {
                const currItem = document.getElementById(`tabItem_${activeTabId}`);
                const currPane = document.getElementById(`tabPane_${activeTabId}`);
                if (currItem) currItem.querySelector('.nav-tab-link').classList.remove('active');
                if (currPane) currPane.classList.remove('active');
            }

            // Activate new
            activeTabId = id;
            const newItem = document.getElementById(`tabItem_${id}`);
            const newPane = document.getElementById(`tabPane_${id}`);

            if (newItem) newItem.querySelector('.nav-tab-link').classList.add('active');
            if (newPane) newPane.classList.add('active');
        }

        function deleteTab(id) {
            const item = document.getElementById(`tabItem_${id}`);
            const pane = document.getElementById(`tabPane_${id}`);

            if (item) item.remove();
            if (pane) pane.remove();

            // Destroy CKEditor instance
            if (editors[id]) {
                editors[id].destroy().then(() => {
                    delete editors[id];
                });
            }

            if (activeTabId === id) {
                const tabs = document.querySelectorAll('.nav-tab-item');
                if (tabs.length > 0) {
                    const lastId = tabs[tabs.length - 1].id.replace('tabItem_', '');
                    switchTab(parseInt(lastId));
                } else {
                    activeTabId = null;
                }
            }
        }

        // --- API Integration ---
        const token = localStorage.getItem('cms_token');
        if (!token) window.location.href = 'login.html';

        const urlParams = new URLSearchParams(window.location.search);
        const newsId = urlParams.get('id');

        // Identify Page Mode
        if (newsId) {
            document.querySelector('.page-title').innerText = 'บทความ: แก้ไขข้อมูล';
        }

        async function loadCategories() {
            try {
                const res = await fetch('/api/categories', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const categories = await res.json();
                const select = document.getElementById('categoryIdSelect');
                select.innerHTML = '<option value="">-- เลือกหมวดหมู่ --</option>';
                categories.forEach(cat => {
                    select.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        async function loadNewsData() {
            if (!newsId) return;

            try {
                const res = await fetch(`/api/news/${newsId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                // Populate Fields
                document.getElementById('titleInput').value = data.title;
                if (data.category_id) {
                    document.getElementById('categoryIdSelect').value = data.category_id;
                }
                if (data.publish_date) {
                    const date = new Date(data.publish_date);
                    const yyyy = date.getFullYear();
                    const mm = String(date.getMonth() + 1).padStart(2, '0');
                    const dd = String(date.getDate()).padStart(2, '0');
                    document.getElementById('publishedDateInput').value = `${yyyy}-${mm}-${dd}`;
                }

                // --- Handle Content ---
                const content = data.content || '';

                // document.getElementById('editor').value = content;
                if (editors.main) {
                    editors.main.setData(content);
                }

                // Image Preview
                if (data.image_url) {
                    const imgPreview = document.getElementById('imagePreview');
                    imgPreview.src = data.image_url;
                    imgPreview.style.display = 'block';
                    document.getElementById('coverUrlInput').value = data.image_url;
                }

                if (data.status !== undefined) {
                    document.getElementById('statusSelect').value = data.status;
                }

                // Gallery Images
                if (data.gallery_images) {
                    if (typeof data.gallery_images === 'string') {
                        try {
                            currentGallery = JSON.parse(data.gallery_images);
                        } catch (e) { currentGallery = []; }
                    } else if (Array.isArray(data.gallery_images)) {
                        currentGallery = data.gallery_images;
                    }
                    renderGalleryPreviews();
                }

            } catch (error) {
                console.error('Error loading news:', error);
            }
        }



        async function saveNews(closeAfter = false) {
            const title = document.getElementById('titleInput').value;
            const categoryId = document.getElementById('categoryIdSelect').value;
            const publishDate = document.getElementById('publishedDateInput').value;

            // Get content from CKEditor
            let finalContent = '';
            if (editors.main) {
                finalContent = editors.main.getData();
            } else {
                // Fallback if no editor?
                finalContent = document.getElementById('editor').value;
            }
            if (!title) {
                alert('กรุณากรอกหัวข้อ');
                return;
            }

            const formData = new FormData();
            formData.append('title', title);
            formData.append('category_id', categoryId);
            formData.append('publish_date', publishDate);
            formData.append('content', finalContent);

            const status = document.getElementById('statusSelect').value;
            formData.append('status', status);

            const coverUrl = document.getElementById('coverUrlInput').value;
            // If coverUrl exists, prioritized. 
            // If editing existing, we might not have coverUrl input set if we didn't touch it? 
            // - current logic: loadNewsData sets imgPreview source but NOT coverUrlInput value? 
            //   Wait, loadNewsData sets imgPreview.src = data.image_url
            //   If user doesn't change it, we should probably submit nothing? 
            //   But if we want to change it via assets...
            //   Let's check if coverUrlInput is set. If not, don't send anything (backend keeps existing).
            //   However, if we CHANGED it via selectAsset, coverUrlInput IS set.
            //   Wait, `selectAsset` sets `document.getElementById('coverUrlInput').value = path;`.

            if (coverUrl) {
                formData.append('image_url', coverUrl);
            }

            // Gallery
            formData.append('existing_gallery_images', JSON.stringify(currentGallery));

            try {
                const method = newsId ? 'PUT' : 'POST';
                const url = newsId ? `/api/news/${newsId}` : '/api/news';

                const res = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (res.ok) {
                    alert('บันทึกข้อมูลเรียบร้อย');
                    if (closeAfter) {
                        window.location.href = 'news_content.html';
                    } else if (!newsId) {
                        window.location.href = 'news_content.html';
                    }
                } else {
                    const err = await res.json();
                    alert('Error: ' + err.message);
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('An error occurred while saving.');
            }
        }

        // Dummy File System (Populate this via API in production)
        const fileSystem = {
            "assets": {
                type: "folder",
                children: {
                    "images": {
                        type: "folder",
                        children: {
                            "logo.png": { type: "file" },
                            "banner.png": { type: "file" }
                        }
                    }
                }
            }
        };

        let editors = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Init Custom CKEditor 5
            CKEDITOR.ClassicEditor.create(document.getElementById("editor"), {
                licenseKey: 'GPL',
                language: 'th',
                toolbar: {
                    items: [
                        'heading',
                        '|',
                        'bold', 'italic', 'underline', 'strikethrough', 'code', 'subscript', 'superscript', 'removeFormat',
                        '|',
                        'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor', 'highlight',
                        '|',
                        'alignment',
                        '|',
                        'bulletedList', 'numberedList', 'todoList', 'outdent', 'indent',
                        '|',
                        'link', 'uploadImage', 'blockQuote', 'insertTable', 'mediaEmbed', 'codeBlock', 'htmlEmbed',
                        '|',
                        'specialCharacters', 'horizontalLine', 'pageBreak',
                        '|',
                        'sourceEditing',
                        '|',
                        'undo', 'redo',
                        '|',
                        'findAndReplace'
                    ],
                    shouldNotGroupWhenFull: true
                },
                image: {
                    toolbar: [
                        'imageStyle:inline',
                        'imageStyle:block',
                        'imageStyle:side',
                        '|',
                        'toggleImageCaption',
                        'imageTextAlternative'
                    ]
                },
                table: {
                    contentToolbar: [
                        'tableColumn',
                        'tableRow',
                        'mergeTableCells',
                        'tableProperties',
                        'tableCellProperties'
                    ]
                },
                fontFamily: {
                    options: [
                        'default',
                        'Kanit, Arial, sans-serif',
                        'Arial, Helvetica, sans-serif',
                        'Courier New, Courier, monospace',
                        'Georgia, serif',
                        'Lucida Sans Unicode, Lucida Grande, sans-serif',
                        'Tahoma, Geneva, sans-serif',
                        'Times New Roman, Times, serif',
                        'Trebuchet MS, Helvetica, sans-serif',
                        'Verdana, Geneva, sans-serif'
                    ],
                    supportAllValues: true
                },
                fontSize: {
                    options: [10, 12, 14, 'default', 18, 20, 22],
                    supportAllValues: true
                },
                htmlSupport: {
                    allow: [
                        {
                            name: /.*/,
                            attributes: true,
                            classes: true,
                            styles: true
                        }
                    ]
                },
                mediaEmbed: {
                    previewsInData: true
                },
                extraPlugins: [MyCustomUploadAdapterPlugin]
            })
                .then(newEditor => {
                    editors.main = newEditor;
                    loadNewsData(); // Load data after editor is ready
                })
                .catch(error => {
                    console.error('CKEditor Init Error:', error);
                });


            loadCategories();
            // loadNewsData is called inside then() of editor creation
        });


        function insertCard() {
            if (!activeTabId || !editors[activeTabId]) return alert('กรุณาเลือกแท็บที่ต้องการแก้ไข');
            const editor = editors[activeTabId];

            const html = `
            <div class="card" style="border:1px solid #ddd; max-width:300px; padding:10px; margin:10px; border-radius:4px;">
                <img src="https://via.placeholder.com/300x150" style="width:100%; height:auto;" alt="Card Image">
                <div style="padding:10px;">
                    <h3>Card Title</h3>
                    <p>Sample description text.</p>
                </div>
            </div><p>&nbsp;</p>
            `;
            const viewFragment = editor.data.processor.toView(html);
            const modelFragment = editor.data.toModel(viewFragment);
            editor.model.insertContent(modelFragment);
        }

        function insertGrid() {
            if (!activeTabId || !editors[activeTabId]) return alert('กรุณาเลือกแท็บที่ต้องการแก้ไข');
            const editor = editors[activeTabId];

            const html = `
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div style="background:#f9f9f9; padding:10px;">col 1</div>
                <div style="background:#f9f9f9; padding:10px;">col 2</div>
            </div><p>&nbsp;</p>
            `;
            const viewFragment = editor.data.processor.toView(html);
            const modelFragment = editor.data.toModel(viewFragment);
            editor.model.insertContent(modelFragment);
        }


        function removeCoverImage() {
            document.getElementById('imagePreview').src = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('coverUrlInput').value = '';
        }

        // --- Media Modal Logic ---
        let modalMode = null; // 'cover' or 'gallery'
        let modalPathStack = [{ id: 0, name: 'assets' }];
        let selectedModalFiles = new Set(); // Store selected paths

        function openMediaModal(mode) {
            modalMode = mode;
            document.getElementById('mediaModal').style.display = 'flex';
            modalPathStack = [{ id: 0, name: 'assets' }]; // Reset to root
            selectedModalFiles.clear(); // Reset selection

            // Show/Hide Confirm Button based on mode
            const confirmBtn = document.getElementById('modalConfirmBtn');
            if (mode === 'gallery') {
                confirmBtn.style.display = 'inline-block';
            } else {
                confirmBtn.style.display = 'none';
            }

            fetchModalMedia(0);
        }

        function closeMediaModal() {
            document.getElementById('mediaModal').style.display = 'none';
            modalMode = null;
        }

        function getCurrentModalFolderId() {
            return modalPathStack[modalPathStack.length - 1].id;
        }

        async function fetchModalMedia(parentId = 0) {
            try {
                // Reuse the same API as media.html
                const res = await fetch(`/api/media?parent_id=${parentId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const items = await res.json();
                renderModalFiles(items);
            } catch (e) { console.error(e); }
        }

        function renderModalFiles(items) {
            const container = document.getElementById('modalFileList');
            const breadcrumb = document.getElementById('modalBreadcrumb');
            container.innerHTML = '';

            // Update Breadcrumb
            const breadcrumbHtml = modalPathStack.map((folder, index) => {
                const isLast = index === modalPathStack.length - 1;
                const style = isLast ? 'color: #333; font-weight: 600;' : 'color: #1a73e8; cursor: pointer; text-decoration: underline;';
                const onclick = isLast ? '' : `onclick="navigateToModalIndex(${index})"`;
                return `<span ${onclick} style="${style}">${folder.name}</span>`;
            }).join(' <span style="color:#999; margin:0 5px;">/</span> ');
            breadcrumb.innerHTML = breadcrumbHtml;


            if (items.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #999; padding: 30px;">โฟลเดอร์ว่างเปล่า</div>';
                return;
            }

            items.forEach(item => {
                const isFolder = item.is_folder;
                const icon = isFolder ? 'fa-folder' : 'fa-image';
                const color = isFolder ? '#ffc107' : '#17a2b8';

                let thumbnailHtml = `<i class="fa-solid ${icon}" style="font-size: 3rem; color: ${color};"></i>`;
                if (!isFolder && ['.jpg', '.jpeg', '.png', '.gif', '.webp'].includes(item.file_type.toLowerCase())) {
                    thumbnailHtml = `<img src="${item.file_path}" style="max-width:100%; max-height:100%; object-fit:contain;">`;
                }

                const div = document.createElement('div');
                div.style = "cursor: pointer; text-align: center; border: 1px solid #eee; padding: 10px; border-radius: 4px; background:#fff; transition: box-shadow 0.2s; position: relative;";

                // Highlight if selected
                if (!isFolder && selectedModalFiles.has(item.file_path)) {
                    div.style.border = "2px solid #28a745";
                    div.style.background = "#e8f5e9";
                }

                // Click action
                if (isFolder) {
                    div.onclick = () => enterModalFolder(item.id, item.file_name);
                } else {
                    div.onclick = () => selectAsset(item.file_path);
                }

                div.onmouseover = () => div.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
                div.onmouseout = () => div.style.boxShadow = 'none';

                div.innerHTML = `
                    <div style="height: 80px; display: flex; align-items: center; justify-content: center; margin-bottom: 5px;">
                        ${thumbnailHtml}
                    </div>
                    <div style="font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.file_name}</div>
                     ${(!isFolder && selectedModalFiles.has(item.file_path)) ? '<div style="position: absolute; top: 5px; right: 5px; color: #28a745;"><i class="fa-solid fa-circle-check"></i></div>' : ''}
                `;
                container.appendChild(div);
            });
        }

        function enterModalFolder(id, name) {
            modalPathStack.push({ id, name });
            fetchModalMedia(id);
        }

        function navigateToModalIndex(index) {
            modalPathStack = modalPathStack.slice(0, index + 1);
            fetchModalMedia(getCurrentModalFolderId());
        }

        function navigateUpModal() {
            if (modalPathStack.length > 1) {
                modalPathStack.pop();
                fetchModalMedia(getCurrentModalFolderId());
            }
        }

        function selectAsset(path) {
            if (modalMode === 'cover') {
                document.getElementById('coverUrlInput').value = path;
                const img = document.getElementById('imagePreview');
                img.src = path;
                img.style.display = 'block';
                closeMediaModal();
            } else if (modalMode === 'card_image') {
                document.getElementById('genCardImage').value = path;
                closeMediaModal();
            } else if (modalMode === 'gallery') {
                // Toggle selection
                if (selectedModalFiles.has(path)) {
                    selectedModalFiles.delete(path);
                } else {
                    selectedModalFiles.add(path);
                }
                // Re-render to show selection state (inefficient but safe)
                // In a real app we'd toggle classes, but here we redraw
                fetchModalMedia(getCurrentModalFolderId());
                // Wait, fetching again is network-heavy. Let's just re-render current items if we had them.
                // But we don't have 'items' easily available here globally. 
                // Actually, let's just trigger a click or update style manually? 
                // For simplicity, let's just call fetchModalMedia which is cached by browser/fast enough or valid.
                // Better: Just update the specific element style if we could identify it. 
                // Let's stick to simplest: re-fetch. Ideally we should store 'currentItems' in a variable.
            }
        }

        function confirmModalSelection() {
            if (modalMode === 'gallery') {
                selectedModalFiles.forEach(path => {
                    currentGallery.push(path);
                });
                renderGalleryPreviews();
                closeMediaModal();
            }
        }

        function removeGalleryItem(index) {
            currentGallery.splice(index, 1);
            renderGalleryPreviews();
        }

        function renderGalleryPreviews() {
            const container = document.getElementById('galleryPreviewContainer');
            container.innerHTML = '';

            currentGallery.forEach((url, index) => {
                const div = document.createElement('div');
                div.style.position = 'relative';
                div.style.border = '1px solid #ddd';
                div.style.borderRadius = '4px';
                div.style.overflow = 'hidden';
                div.style.aspectRatio = '1/1';

                div.innerHTML = `
                    <img src="${url}" style="width: 100%; height: 100%; object-fit: cover;">
                    <button type="button" onclick="removeGalleryItem(${index})" 
                        style="position: absolute; top: 2px; right: 2px; background: rgba(255,255,255,0.8); border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; color: red;">
                        <i class="fa-solid fa-times"></i>
                    </button>
                `;
            });
        }

        // --- Card Generator Logic ---
        function generateCardHtml() {
            const img = document.getElementById('genCardImage').value || 'fa-solid fa-star';
            const title = document.getElementById('genCardTitle').value || 'Card Title';
            const sub = document.getElementById('genCardSubtitle').value || '';
            const btn = document.getElementById('genCardBtnText').value || 'Click';
            const link = document.getElementById('genCardLink').value || '#';

            let iconHtml = '';
            if (img.startsWith('http') || img.startsWith('/') || img.startsWith('assets')) {
                iconHtml = `<img src="${img}" alt="icon">`;
            } else {
                iconHtml = `<i class="${img}"></i>`;
            }

            const html = `
<div class="custom-card">
    <div class="custom-card-icon">
        ${iconHtml}
    </div>
    <div>
        <div class="custom-card-title">${title}</div>
        <div class="custom-card-subtitle">${sub}</div>
    </div>
    <a href="${link}" class="custom-btn-outline" style="text-decoration:none;">${btn}</a>
</div>`.trim();

            navigator.clipboard.writeText(html).then(() => {
                alert('คัดลอกโค้ดเรียบร้อย! (Copied to clipboard)\n\nกรุณาเปลี่ยนไปที่โหมด "Source" หรือ "< >" ในตัวแก้ไขเนื้อหา แล้วกด Ctrl+V เพื่อวาง');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                prompt("ไม่สามารถคัดลอกอัตโนมัติได้ กรุณาคัดลอกโค้ดด้านล่าง:", html);
            });
        }

    </script>
    <script src="js/global-loader.js"></script>
</body>

</html>